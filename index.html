<!DOCTYPE html>
<html lang="id">
<head>
	<link rel="icon" href="https://images.icon-icons.com/567/PNG/512/store_icon-icons.com_54371.png" type="image/x-icon">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LJU ğŸ§  | Logistik Jitu Update - East Java Intelligence Network</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        @media (min-width: 640px) {
            .glass-panel {
                border-radius: 24px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
        }
        
        .neo-card {
            background: white;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #d1d5db, -8px -8px 16px #ffffff;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .neo-card:hover {
            transform: translateY(-5px);
            box-shadow: 12px 12px 24px #d1d5db, -12px -12px 24px #ffffff;
            border-color: #8B5CF6;
        }
        
        .map-container {
            height: 250px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        @media (min-width: 640px) {
            .map-container {
                height: 320px;
            }
        }
        
        @media (min-width: 768px) {
            .map-container {
                height: 400px;
            }
        }
        
        @media (min-width: 1024px) {
            .map-container {
                height: 500px;
            }
        }
        
        @media (min-width: 1280px) {
            .map-container {
                height: 600px;
            }
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.98);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }
        
        .spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .region-card {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid transparent;
        }
        
        .region-card:hover {
            transform: scale(1.02);
            border-color: #FF6B35;
        }
        
        .region-card.active {
            background: linear-gradient(135deg, #FF6B35, #f5576c);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }
        
        .price-ticker {
            display: flex;
            gap: 1rem;
            animation: scroll 35s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        @media (max-width: 640px) {
            .price-ticker {
                animation: scroll-mobile 20s linear infinite;
            }
            
            @keyframes scroll-mobile {
                0% { transform: translateX(100%); }
                100% { transform: translateX(-100%); }
            }
        }
        
        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .source-bpn { background: #dbeafe; color: #1e40af; }
        .source-siskaperbapo { background: #dcfce7; color: #166534; }
        .source-sp2kp { background: #fef3c7; color: #92400e; }
        .source-local { background: #f3e8ff; color: #7c3aed; }
        
        .status-online { background: #10B981; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.3); }
        .status-offline { background: #EF4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3); }
        .status-syncing { background: #F59E0B; box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3); animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            transition: all 0.3s;
        }
        
        .sync-active {
            background: #dcfce7;
            color: #166534;
            animation: pulse 2s infinite;
        }
        
        .api-log {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .api-log .success { color: #4ade80; }
        .api-log .error { color: #f87171; }
        .api-log .info { color: #60a5fa; }
        
        .data-source-card {
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .data-source-card:hover {
            border-color: #FF6B35;
            transform: translateY(-2px);
        }
        
        .data-source-card.syncing {
            border-color: #F59E0B;
            background: #fffbeb;
        }
        
        .data-source-card.synced {
            border-color: #10B981;
            background: #f0fdf4;
        }
        
        .data-source-card.error {
            border-color: #EF4444;
            background: #fef2f2;
        }
        
        /* Apple device specific responsive improvements */
        @media screen and (max-width: 768px) {
            .map-container {
                height: 250px !important;
            }
            
            /* Ensure proper spacing on smaller screens */
            .glass-panel {
                margin: 0.5rem;
                padding: 0.75rem !important;
            }
            
            /* Adjust font sizes for better readability on mobile */
            .font-fredoka, .font-nunito {
                font-size: 14px;
            }
            
            /* Make sure buttons are touch-friendly */
            button, select {
                min-height: 44px; /* Minimum touch target size for iOS */
                min-width: 44px;
            }
            
            /* Adjust table for mobile */
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 4px !important;
            }
        }
        
        /* Specific iPhone adjustments */
        @media screen and (max-width: 414px) {
            /* iPhone 6/7/8 Plus and similar */
            .glass-panel {
                margin: 0.25rem;
            }
            
            nav {
                padding: 0.5rem !important;
            }
        }
        
        /* iPhone SE and similar small screens */
        @media screen and (max-width: 320px) {
            .glass-panel {
                padding: 0.5rem !important;
            }
            
            .datetime-widget {
                flex-direction: column;
                align-items: flex-start !important;
            }
        }
        
        /* iPhone X and newer models with notch */
        @media only screen and (min-device-width: 375px) and (max-device-width: 812px) and (-webkit-device-pixel-ratio: 3) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            nav {
                padding-top: calc(env(safe-area-inset-top) + 0.5rem);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
        
        /* Additional Apple device specific styles */
        @supports (-webkit-touch-callout: none) {
            /* iOS specific styles */
            .glass-panel {
                -webkit-backdrop-filter: blur(20px);
                backdrop-filter: blur(20px);
            }
            
            /* Prevent overscroll bounce */
            body {
                position: fixed;
                width: 100%;
            }
            
            .scrollable-content {
                position: relative;
                height: calc(100vh - 128px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* iPad specific styles */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .map-container {
                height: 300px !important;
            }
            
            .glass-panel {
                margin: 0.5rem;
                padding: 0.75rem !important;
            }
        }
        
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .map-container {
                height: 250px !important;
            }
            
            .glass-panel {
                margin: 0.5rem;
                padding: 1rem !important;
            }
        }
        
        /* iPhone SE specific styles */
        @media screen and (max-width: 320px) and (max-height: 568px) {
            .glass-panel {
                padding: 0.5rem !important;
                margin: 0.25rem !important;
            }
            
            .map-container {
                height: 200px !important;
            }
            
            .font-fredoka, .font-nunito {
                font-size: 13px;
            }
            
            button, select, input {
                min-height: 40px;
                padding: 0.5rem 1rem;
            }
        }
        
        /* iPhone 6/7/8 specific styles */
        @media screen and (max-width: 414px) and (max-height: 736px) {
            .map-container {
                height: 220px !important;
            }
            
            .glass-panel {
                padding: 0.75rem !important;
            }
        }
        
        /* iPhone 12 Pro Max and similar large screens */
        @media screen and (min-width: 428px) and (max-width: 430px) {
            .map-container {
                height: 280px !important;
            }
        }
        
        /* Landscape orientation fixes for iOS */
        @media screen and (orientation: landscape) and (max-height: 414px) {
            .map-container {
                height: 180px !important;
            }
            
            nav {
                padding: 0.25rem !important;
            }
            
            .glass-panel {
                padding: 0.5rem !important;
            }
        }
        
        /* Dynamic viewport height for iOS devices with safe areas */
        :root {
            --vh: 1vh;
        }
        
        /* Apply dynamic viewport height to body for iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                height: calc(var(--vh, 1vh) * 100);
                overflow: hidden;
            }
            
            .scrollable-content {
                height: calc(var(--vh, 1vh) * 100 - 128px);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="text-slate-800 overflow-x-hidden" style="position: relative; height: 100vh;">

    <!-- Loading Overlay -->
    <!--<div id="loading-overlay" class="loading-overlay">
        <div class="spinner mb-6"></div>
        <h2 class="font-fredoka text-3xl font-bold text-slate-800 mb-2">LJU Intelligence Network</h2>
        <p class="text-slate-600 mb-6">Inisialisasi koneksi ke 34 endpoint data...</p>
        <div class="flex gap-3 flex-wrap justify-center max-w-3xl" id="loading-status">
            <span class="px-4 py-2 bg-slate-100 text-slate-600 rounded-full text-sm font-bold flex items-center gap-2">
                <i class="fas fa-circle-notch fa-spin"></i> Menghubungkan...
            </span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass-panel mx-2 sm:mx-4 mt-2 sm:mt-4 max-w-[calc(100%-1rem)] sm:max-w-[calc(100%-2rem)]">
        <div class="flex flex-col sm:flex-row justify-between items-center px-4 py-3">
            <div class="flex items-center gap-3 w-full sm:w-auto mb-2 sm:mb-0">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-2xl flex items-center justify-center text-white text-xl font-black transform -rotate-6 shadow-lg relative">
                    LJU
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white animate-pulse" id="nav-status-indicator"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <h1 class="font-fredoka text-lg sm:text-xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent truncate">
                        Logistik Jitu Update
                    </h1>
                    <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-600">
                        <span id="connection-status" class="w-2 h-2 rounded-full status-online"></span>
                        <span id="connection-text" class="truncate">System Ready</span>
                        <span id="sync-status" class="sync-indicator sync-active hidden">
                            <i class="fas fa-sync fa-spin"></i> Syncing...
                        </span>
                    </div>
                </div>
            </div>

            <!--<div class="flex items-center gap-2 w-full sm:w-auto justify-end">
                <div class="sm:hidden ml-auto">
                    <button id="mobile-menu-btn" class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center text-white shadow-lg" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                
                <div id="mobile-menu" class="hidden sm:hidden w-full absolute top-20 left-0 right-0 bg-white/95 backdrop-blur-md p-4 rounded-b-2xl shadow-lg z-40">
                    <div class="flex flex-col gap-3">
                        <div class="flex items-center gap-3 bg-white/50 px-4 py-2 rounded-full border-2 border-orange-200">
                            <i class="fas fa-network-wired text-orange-500"></i>
                            <select id="region-selector" class="bg-transparent font-bold text-slate-700 focus:outline-none cursor-pointer w-full text-xs sm:text-sm" onchange="changeRegion(this.value)">
                                <option value="all">ğŸ“ Semua Zona</option>
                                <option value="1">ğŸŒŠ Zona 1</option>
                                <option value="2">ğŸŒ¾ Zona 2</option>
                                <option value="3">â›°ï¸ Zona 3</option>
                                <option value="4">ğŸ”ï¸ Zona 4</option>
                                <option value="5">ğŸ›ï¸ Zona 5</option>
                                <option value="6">ğŸŒ¾ Zona 6</option>
                                <option value="7">ğŸ­ Zona 7</option>
                                <option value="8">ğŸ­ Zona 8</option>
                                <option value="9">ğŸï¸ Zona 9</option>
                                <option value="10">ğŸŒŠ Zona 10</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-2 justify-center">
                            <button onclick="forceSync()" class="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center text-white shadow-lg" id="sync-btn">
                                <i class="fas fa-sync-alt" id="sync-icon"></i>
                            </button>
                        </div>
                    
                </div>
                
                <div class="hidden sm:flex items-center gap-3 bg-white/50 px-4 py-2 rounded-full border-2 border-orange-200">
                    <i class="fas fa-network-wired text-orange-500"></i>
                    <select id="region-selector" class="bg-transparent font-bold text-slate-700 focus:outline-none cursor-pointer text-sm" onchange="changeRegion(this.value)">
                        <option value="all">ğŸ“ Semua Zona</option>
                        <option value="1">ğŸŒŠ Zona 1</option>
                        <option value="2">ğŸŒ¾ Zona 2</option>
                        <option value="3">â›°ï¸ Zona 3</option>
                        <option value="4">ğŸ”ï¸ Zona 4</option>
                        <option value="5">ğŸ›ï¸ Zona 5</option>
                        <option value="6">ğŸŒ¾ Zona 6</option>
                        <option value="7">ğŸ­ Zona 7</option>
                        <option value="8">ğŸ­ Zona 8</option>
                        <option value="9">ğŸï¸ Zona 9</option>
                        <option value="10">ğŸŒŠ Zona 10</option>
                    </select>
                </div>--!>

                <button onclick="forceSync()" class="relative w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 transition-transform hidden sm:block" id="sync-btn">
                    <i class="fas fa-sync-alt" id="sync-icon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="scrollable-content">
    <main class="pt-32 pb-6 px-2 sm:px-4 max-w-7xl mx-auto space-y-3 sm:space-y-6">

        </div>

	<!-- Data Comparison Table -->
        <div class="glass-panel p-4 sm:p-6">
            <div class="flex flex-col gap-4 mb-4 sm:mb-6">
                <div>
                    <h3 class="font-fredoka text-lg sm:text-xl font-bold">ğŸ“Š Perbandingan Harga Multi-Sumber</h3>
                    <p class="text-xs sm:text-sm text-slate-500">PIHPS vs Siskaperbapo vs SP2KP vs Local Government</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <div id="datetime-widget" class="bg-white border-2 border-slate-200 rounded-full px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-bold flex items-center flex-shrink-0">
                        <i class="fas fa-calendar-day mr-1 sm:mr-2 text-orange-500"></i>
                        <span id="current-date">--/--/----</span>
                        <span class="mx-1 sm:mx-2">|</span>
                        <i class="fas fa-clock mr-1 sm:mr-2 text-orange-500"></i>
                        <span id="current-time">--:--:--</span>
                    </div>
                    <div class="relative flex-grow min-w-[200px]">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="ğŸ” Cari komoditas..." 
                            class="w-full bg-white border-2 border-slate-200 rounded-full px-4 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-bold focus:outline-none focus:border-orange-500 min-h-[44px] pr-10"
                            onkeyup="searchTable()"
                        >
                        <i class="fas fa-search absolute right-8 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                        <button 
                            type="button" 
                            id="clear-search-btn" 
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 text-sm hidden"
                            onclick="clearSearch()"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <select id="compare-commodity" class="bg-white border-2 border-slate-200 rounded-full px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-bold focus:outline-none focus:border-orange-500 flex-grow min-w-[150px]" onchange="updateComparison()">
                        <option value="all" selected>ğŸ“Š Semua Komoditas</option>
                        <option value="Beras">ğŸŒ¾ Beras Medium</option>
                        <option value="Beras Premium">ğŸš Beras Premium</option>
                        <option value="Minyak">ğŸ›¢ï¸ Minyak Curah</option>
                        <option value="Minyak Premium">â›½ Minyak Premium</option>
                        <option value="Gula">ğŸ¬ Gula</option>
                        <option value="Gula Premium">ğŸ¯ Gula Premium</option>
                        <option value="Daging">ğŸ¥© Daging</option>
                        <option value="Daging Ayam Kampung">ğŸ— Daging Ayam Kampung</option>
                        <option value="Ayam">ğŸ” Ayam</option>
                        <option value="Telur">ğŸ¥š Telur</option>
                        <option value="Telur Ayam Kampung">ğŸ£ Telur Ayam Kampung</option>
                        <option value="Cabai">ğŸŒ¶ï¸ Cabai Rawit</option>
                        <option value="Cabai Merah Besar">ğŸ”´ Cabai Merah Besar</option>
                        <option value="Cabai Keriting">â° Cabai Keriting</option>
                        <option value="Bawang">ğŸ§… Bawang Putih</option>
                        <option value="Bawang Merah">ğŸ§… Bawang Merah</option>
                        <option value="Garam">ğŸ§‚ Garam</option>
                        <option value="Tepung">ğŸ Tepung</option>
                        <option value="Wortel">ğŸ¥• Wortel</option>
                        <option value="Sawi">ğŸ¥¬ Sawi</option>
                        <option value="Jagung">ğŸŒ½ Jagung</option>
                        <option value="Buncis">ğŸ«˜ Buncis</option>
                        <option value="Brokoli">ğŸ¥¦ Brokoli</option>
                        <option value="Selada">ğŸ¥— Selada</option>
                        <option value="Sayur Putih">ğŸ¥¬ Sayur Putih</option>
                        <option value="Pakcoy">ğŸ¥¬ Pakcoy</option>
                        <option value="Jamur Tiram">ğŸ„ Jamur Tiram</option>
                        <option value="Bunga Kol">ğŸ¥¬ Bunga Kol</option>
                        <option value="Kecambah">ğŸŒ± Kecambah</option>
                        <option value="Kacang Tanah">ğŸ¥œ Kacang Tanah</option>
                        <option value="Seledri">ğŸŒ¿ Seledri</option>
                        <option value="Asem">ğŸ‹ Asem</option>
                        <option value="Kunyit">ğŸ’› Kunyit</option>
                        <option value="Kemiri">ğŸŒ° Kemiri</option>
                        <option value="Daun Bawang">ğŸŒ¿ Daun Bawang</option>
                        <option value="Kubis">ğŸ¥¬ Kubis</option>
                        <option value="Baby Corn">ğŸŒ½ Baby Corn</option>
                        <option value="Timun">ğŸ¥’ Timun</option>
                        <option value="Kacang Panjang">ğŸ«˜ Kacang Panjang</option>
                        <option value="Edaname">ğŸŒ± Edaname</option>
                        <option value="Terong Hijau">ğŸ† Terong Hijau</option>
                        <option value="Terong Ungu">ğŸ† Terong Ungu</option>
                        <option value="Tahu">â¬œ Tahu</option>
                        <option value="Tempe">ğŸŸ¤ Tempe</option>
                        <option value="Susu UHT">ğŸ¥› Susu UHT</option>
                        <option value="Tomat">ğŸ… Tomat</option>
                        <option value="Apel Fuji">ğŸ Apel Fuji</option>
                        <option value="Apel Hijau Malang">ğŸ Apel Hijau Malang</option>
                        <option value="Anggur Merah">ğŸ‡ Anggur Merah</option>
                        <option value="Anggur Muscat">ğŸˆ Anggur Muscat</option>
                        <option value="Kelengkeng Emas">ğŸ’ Kelengkeng Emas</option>
                        <option value="Kelengkeng Merah">ğŸ’ Kelengkeng Merah</option>
                        <option value="Minyak Kita">ğŸ«’ Minyak Kita</option>
                        <option value="Jeruk Santang">ğŸŠ Jeruk Santang</option>
                        <option value="Jeruk Manis">ğŸŠ Jeruk Manis</option>
                        <option value="Jeruk Baby">ğŸŠ Jeruk Baby</option>
                        <option value="Pir Yali">ğŸ Pir Yali</option>
                        <option value="Buah Naga">ğŸ‰ Buah Naga</option>
                        <option value="Pisang Ambon">ğŸŒ Pisang Ambon</option>
                        <option value="Pisang Cavendish">ğŸŒ Pisang Cavendish</option>
                        <option value="Salak Pondoh">ğŸ¥­ Salak Pondoh</option>
                        <option value="Jeruk Lokal">ğŸŠ Jeruk Lokal</option>
                        <option value="Melon">ğŸˆ Melon</option>
                        <option value="Semangka">ğŸ‰ Semangka</option>
                    </select>
                    <select id="compare-region" class="bg-white border-2 border-slate-200 rounded-full px-3 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm font-bold focus:outline-none focus:border-orange-500 flex-grow min-w-[120px]" onchange="updateComparison()">
                        <option value="all">ğŸ“ Semua Zona</option>
                        <option value="1">ğŸŒŠ Zona 1</option>
                        <option value="2">ğŸŒ¾ Zona 2</option>
                        <option value="3">â›°ï¸ Zona 3</option>
                        <option value="4">ğŸ”ï¸ Zona 4</option>
                        <option value="5">ğŸ›ï¸ Zona 5</option>
                        <option value="6">ğŸŒ¾ Zona 6</option>
                        <option value="7">ğŸ­ Zona 7</option>
                        <option value="8">ğŸ­ Zona 8</option>
                        <option value="9">ğŸï¸ Zona 9</option>
                        <option value="10">ğŸŒŠ Zona 10</option>
                    </select>
                    <button onclick="exportComparison()" class="px-3 py-1 sm:px-4 sm:py-2 bg-green-500 text-white rounded-full text-xs sm:text-sm font-bold hover:scale-105 transition-transform flex-shrink-0">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                    <thead>
                        <tr class="bg-gradient-to-r from-orange-100 to-red-100">
                            <th class="p-1.5 sm:p-2 text-left rounded-tl-xl min-w-[80px]">Wilayah</th>
                            <th class="p-1.5 sm:p-2 text-center min-w-[60px]">Zona</th>
                            <th class="p-1.5 sm:p-2 text-left min-w-[100px]">Nama Barang</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸ›ï¸ BPN</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸ›ï¸ PIHPS</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸŒ¾ Siskaperbapo</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸ“‹ SP2KP</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸ›ï¸ Local API</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸ­ Produsen</th>
                            <th class="p-1.5 sm:p-2 text-right min-w-[70px]">ğŸ“Š Rata-rata</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body" class="divide-y divide-slate-200">
                        <!-- Rows by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Regional Data Sources Grid -->
        <div class="glass-panel p-4 sm:p-6">
            <h2 class="font-fredoka text-lg sm:text-xl font-bold mb-3 sm:mb-4 flex flex-col sm:flex-row items-start sm:items-center gap-1 sm:gap-2">
                <span class="text-orange-500">ğŸ—ºï¸</span> 
                <span>Sumber Data per Wilayah</span>
                <span class="text-xs sm:text-sm font-normal text-slate-500 mt-1 sm:mt-0 sm:ml-auto" id="last-sync-time">Last sync: --</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4" id="sources-grid">
                <!-- Generated by JS -->
            </div>
        </div>
		<!-- Live Price Ticker -->
        <div class="glass-panel p-3 sm:p-4 overflow-hidden bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200">
            <div class="flex flex-col sm:flex-row items-center gap-2 sm:gap-3 mb-2 sm:mb-3">
                <span class="px-3 py-1 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-full text-xs sm:text-sm font-bold flex items-center gap-2 animate-pulse">
                    <span class="w-2 h-2 bg-white rounded-full animate-ping"></span>
                    LIVE FEED
                </span>
                <span class="text-xs sm:text-sm text-slate-600 font-semibold">Data streaming dari 34 sumber</span>
            </div>
            <div class="overflow-hidden">
                <div class="price-ticker" id="price-ticker"></div>
            </div>
        </div>

        <!-- Interactive Map -->
        <div class="glass-panel p-4 sm:p-6">
            <div class="flex flex-col gap-4 mb-4 sm:mb-6">
                <div>
                    <h2 class="font-fredoka text-lg sm:text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="text-2xl sm:text-3xl">ğŸ—ºï¸</span>
                        Peta Harga Real-Time
                    </h2>
                    <p class="text-xs sm:text-sm text-slate-600 mt-1">Data langsung dari BPN, Siskaperbapo, SP2KP & Local APIs</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center sm:justify-start">
                    <button onclick="filterMap('all')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-slate-800 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">Semua</button>
                    <button onclick="filterMap('Beras')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-yellow-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸŒ¾ Beras</button>
                    <button onclick="filterMap('Beras Premium')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-orange-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸš Beras Premium</button>
                    <button onclick="filterMap('Minyak')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-red-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ›¢ï¸ Minyak</button>
                    <button onclick="filterMap('Minyak Premium')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-purple-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">â›½ Minyak Premium</button>
                    <button onclick="filterMap('Gula')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-pink-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¬ Gula</button>
                    <button onclick="filterMap('Gula Premium')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-amber-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¯ Gula Premium</button>
                    <button onclick="filterMap('Wortel')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-green-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥• Wortel</button>
                    <button onclick="filterMap('Sawi')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-lime-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥¬ Sawi</button>
                    <button onclick="filterMap('Jagung')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-amber-600 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸŒ½ Jagung</button>
                    <button onclick="filterMap('Brokoli')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-emerald-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥¦ Brokoli</button>
                    <button onclick="filterMap('Buncis')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-teal-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ«˜ Buncis</button>
                    <button onclick="filterMap('Selada')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-cyan-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥— Selada</button>
                    <button onclick="filterMap('Pakcoy')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-green-400 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥¬ Pakcoy</button>
                    <button onclick="filterMap('Jamur Tiram')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-gray-400 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ„ Jamur Tiram</button>
                    <button onclick="filterMap('Kacang Tanah')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-amber-800 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥œ Kacang Tanah</button>
                    <button onclick="filterMap('Kubis')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-blue-400 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥¬ Kubis</button>
                    <button onclick="filterMap('Timun')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-green-300 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ¥’ Timun</button>
                    <button onclick="filterMap('Tomat')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-red-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ… Tomat</button>
                    <button onclick="filterMap('Tahu')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-white text-black text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">â¬œ Tahu</button>
                    <button onclick="filterMap('Tempe')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-yellow-800 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸŸ¤ Tempe</button>
                    <button onclick="filterMap('Apel Fuji')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-red-600 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ Apel Fuji</button>
                    <button onclick="filterMap('Anggur Merah')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-purple-600 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ‡ Anggur Merah</button>
                    <button onclick="filterMap('Jeruk Santang')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-orange-500 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸŠ Jeruk Santang</button>
                    <button onclick="filterMap('Pisang Ambon')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-yellow-400 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸŒ Pisang Ambon</button>
                    <button onclick="filterMap('Semangka')" class="px-3 py-1 sm:px-4 sm:py-2 rounded-full bg-red-400 text-white text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">ğŸ‰ Semangka</button>
                </div>
            </div>

            <div id="map" class="map-container w-full h-64 sm:h-80 md:h-96"></div>
        </div>
		<!-- Network Status Dashboard -->
        <div class="glass-panel p-4 sm:p-6 border-2 border-blue-200 bg-gradient-to-r from-blue-50 to-indigo-50">
            <div class="flex flex-col gap-4 mb-4">
                <div>
                    <h2 class="font-fredoka text-lg sm:text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-network-wired text-blue-600"></i>
                        Status Jaringan Data
                    </h2>
                    <p class="text-xs sm:text-sm text-slate-600">Real-time connection status ke seluruh sumber data</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-center sm:justify-end">
                    <button onclick="testAllConnections()" class="px-3 py-1 sm:px-4 sm:py-2 bg-blue-500 text-white rounded-full text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">
                        <i class="fas fa-vial"></i> Test Koneksi
                    </button>
                    <button onclick="viewAPILogs()" class="px-3 py-1 sm:px-4 sm:py-2 bg-slate-700 text-white rounded-full text-xs sm:text-sm font-bold hover:scale-105 transition-transform shadow-lg">
                        <i class="fas fa-terminal"></i> API Logs
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4">
                <div class="bg-white p-3 sm:p-4 rounded-xl border-2 border-blue-200 text-center">
                    <div class="text-2xl sm:text-3xl font-black text-blue-600" id="stat-connected">0</div>
                    <div class="text-xs sm:text-xs font-bold text-slate-600">Terhubung</div>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-xl border-2 border-green-200 text-center">
                    <div class="text-2xl sm:text-3xl font-black text-green-600" id="stat-synced">0</div>
                    <div class="text-xs sm:text-xs font-bold text-slate-600">Tersinkron</div>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-xl border-2 border-yellow-200 text-center">
                    <div class="text-2xl sm:text-3xl font-black text-yellow-600" id="stat-pending">0</div>
                    <div class="text-xs sm:text-xs font-bold text-slate-600">Pending</div>
                </div>
                <div class="bg-white p-3 sm:p-4 rounded-xl border-2 border-red-200 text-center">
                    <div class="text-2xl sm:text-3xl font-black text-red-600" id="stat-error">0</div>
                    <div class="text-xs sm:text-xs font-bold text-slate-600">Error</div>
                </div>
            </div>

            <!-- API Console -->
            <div id="api-console" class="hidden api-log">
                <div class="flex justify-between items-center mb-2 pb-2 border-b border-slate-700">
                    <span class="font-bold text-green-400 text-sm">API Communication Log</span>
                    <button onclick="clearLogs()" class="text-xs text-slate-400 hover:text-white">Clear</button>
                </div>
                <div id="log-content" class="space-y-1"></div>
            </div>
        

        

    </main>
    </div> <!-- End of scrollable-content div -->

    <!-- Modal for API Details -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300" id="modal-content">
            <div class="p-4 sm:p-6">
                <div class="flex justify-between items-center mb-3 sm:mb-4 border-b pb-3 sm:pb-4">
                    <h3 class="font-fredoka text-lg sm:text-2xl font-bold text-slate-800" id="modal-title">Detail Koneksi API</h3>
                    <button onclick="closeModal()" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-600 transition-colors">
                        <i class="fas fa-times text-sm sm:text-base"></i>
                    </button>
                </div>
                <div id="modal-body" class="text-slate-600 text-sm"></div>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle function
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mobile-menu');
            const menuBtn = document.getElementById('mobile-menu-btn');
            
            if (!menu.contains(event.target) && !menuBtn.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
        
        // ==========================================
        // DATA SOURCE CONFIGURATION FROM EXCEL
        // ==========================================

        const DATA_SOURCES = [
            {
                zone: 1,
                kabupaten: "Banyuwangi",
                type: "kabupaten",
                coords: [-8.3593, 114.1368],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 1,
                kabupaten: "Situbondo",
                type: "kabupaten",
                coords: [-7.7886, 114.0055],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Sikepo Situbondo", url: "https://sikepo.situbondokab.go.id/", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 2,
                kabupaten: "Lumajang",
                type: "kabupaten",
                coords: [-8.1370, 113.2262],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "DKPP Lumajang", url: "https://dkpp.lumajangkab.go.id/komoditi", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 2,
                kabupaten: "Jember",
                type: "kabupaten",
                coords: [-8.1845, 113.6681],
                endpoints: [
                    { name: "Diskopum", url: "https://diskopum.jemberkab.go.id/posts/daftar-harga-bahan-pokok-penting-bapokting-pada-pasar-pasar-di-kabupaten-jember-per-tanggal-25-februari-2026", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
					{ name: "BPN Nasional", url: "https://badanpangan.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
					
				]
            },
            {
                zone: 3,
                kabupaten: "Bondowoso",
                type: "kabupaten",
                coords: [-7.9674, 113.9060],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 3,
                kabupaten: "Probolinggo",
                type: "kota",
                coords: [-7.7764, 113.2037],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Bag-Ekbang Probolinggo", url: "https://bag-ekbang.probolinggokota.go.id/page/harga-bahan-pokok", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 4,
                kabupaten: "Malang",
                type: "hybrid",
                coords: [-8.1500, 112.6000],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Siharkepo Malang", url: "https://siharkepo.malangkab.go.id/", type: "local", status: "unknown", lastSync: null },
                    { name: "Sembako Malang", url: "https://sembako.malangkota.go.id/", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 4,
                kabupaten: "Pasuruan",
                type: "kabupaten",
                coords: [-7.6469, 112.8993],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 5,
                kabupaten: "Blitar",
                type: "hybrid",
                coords: [-8.0955, 112.1606],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Blitar Kota", url: "http://blitarkota.go.id/index.php/page/650/harga-bahan-pokok", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 5,
                kabupaten: "Kediri",
                type: "hybrid",
                coords: [-7.8235, 112.1628],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Disperdagin Kediri", url: "https://disperdagin.kedirikota.go.id", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 5,
                kabupaten: "Tulungagung",
                type: "kabupaten",
                coords: [-8.0657, 111.9026],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 5,
                kabupaten: "Wonosobo",
                type: "kabupaten",
                coords: [-7.3622, 109.9076],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Harga Jateng", url: "https://hargajateng.org/tabel-harga-kab", type: "jateng", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 5,
                kabupaten: "Magelang",
                type: "hybrid",
                coords: [-7.4797, 110.2177],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Harga Jateng", url: "https://hargajateng.org/tabel-harga-kab", type: "jateng", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Datago Magelang", url: "https://datago.magelangkota.go.id/frontend/inflasi", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 6,
                kabupaten: "Ponorogo",
                type: "kabupaten",
                coords: [-7.8720, 111.4619],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Perdagkum Ponorogo", url: "https://perdagkum.ponorogo.go.id/daftar-harga/", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 6,
                kabupaten: "Trenggalek",
                type: "kabupaten",
                coords: [-8.1820, 111.6188],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 6,
                kabupaten: "Magetan",
                type: "kabupaten",
                coords: [-7.6493, 111.3386],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 7,
                kabupaten: "Bojonegoro",
                type: "kabupaten",
                coords: [-7.3172, 111.7615],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Disdag Bojonegoro", url: "https://disdag-online.bojonegorokab.go.id/", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 7,
                kabupaten: "Gresik",
                type: "kabupaten",
                coords: [-7.1567, 112.6555],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Sibapo Gresik", url: "https://sibapo.gresikkab.go.id", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 7,
                kabupaten: "Lamongan",
                type: "kabupaten",
                coords: [-7.4069, 112.3326],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 8,
                kabupaten: "Mojokerto",
                type: "hybrid",
                coords: [-7.4707, 112.4406],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Newsibapo Mojokerto", url: "https://newsibapo.mojokertokota.go.id/index-harga", type: "local", status: "unknown", lastSync: null },
                    { name: "Perdagangan Mojokerto", url: "https://perdagangan-sinergismart.mojokertokab.go.id/komoditas", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 8,
                kabupaten: "Jombang",
                type: "kabupaten",
                coords: [-7.5741, 112.2861],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 9,
                kabupaten: "Pamekasan",
                type: "kabupaten",
                coords: [-7.0461, 113.7648],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Satu Data Pamekasan", url: "https://satudata.pamekasankab.go.id/harga", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 9,
                kabupaten: "Sumenep",
                type: "kabupaten",
                coords: [-7.0204, 113.8655],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Media Pribumi", url: "https://mediapribumi.id/ini-daftar-harga-bahan-pokok-di-kabupaten-sumenep-terbaru/", type: "local", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 10,
                kabupaten: "Bangkalan",
                type: "kabupaten",
                coords: [-7.0384, 112.9137],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null }
                ]
            },
            {
                zone: 10,
                kabupaten: "Sampang",
                type: "kabupaten",
                coords: [-7.0407, 113.2404],
                endpoints: [
                    { name: "BPN National", url: "https://panelharga.badanpangan.go.id", type: "bpn", status: "unknown", lastSync: null },
                    { name: "Siskaperbapo Jatim", url: "https://siskaperbapo.jatimprov.go.id/", type: "siskaperbapo", status: "unknown", lastSync: null },
                    { name: "SP2KP Kemendag", url: "https://sp2kp.kemendag.go.id/", type: "sp2kp", status: "unknown", lastSync: null },
                    { name: "Sigarang Sampang", url: "https://sigarang.sampangkab.go.id/", type: "local", status: "unknown", lastSync: null }
                ]
            }
        ];

        // ==========================================
        // COMMODITY LIST
        // ==========================================

        const COMMODITIES = ['Beras', 'Beras Premium', 'Minyak', 'Minyak Premium', 'Gula', 'Gula Premium', 'Daging', 'Daging Ayam Kampung', 'Ayam', 'Telur', 'Telur Ayam Kampung', 'Cabai', 'Cabai Merah Besar', 'Cabai Keriting', 'Bawang', 'Bawang Merah', 'Garam', 'Tepung', 'Wortel', 'Sawi', 'Jagung', 'Buncis', 'Brokoli', 'Selada', 'Sayur Putih', 'Pakcoy', 'Jamur Tiram', 'Bunga Kol', 'Kecambah', 'Kacang Tanah', 'Seledri', 'Asem', 'Kunyit', 'Kemiri', 'Daun Bawang', 'Kubis', 'Baby Corn', 'Timun', 'Kacang Panjang', 'Edaname', 'Terong Hijau', 'Terong Ungu', 'Tahu', 'Tempe', 'Susu UHT', 'Tomat', 'Apel Fuji', 'Apel Hijau Malang', 'Anggur Merah', 'Anggur Muscat', 'Kelengkeng Emas', 'Kelengkeng Merah', 'Minyak Kita', 'Jeruk Santang', 'Jeruk Manis', 'Jeruk Baby', 'Pir Yali', 'Buah Naga', 'Pisang Ambon', 'Pisang Cavendish', 'Salak Pondoh', 'Jeruk Lokal', 'Melon', 'Semangka'];

        // ==========================================
        // API INTEGRATION CLASS
        // ==========================================

        class DataSynchronizer {
            constructor() {
                this.logs = [];
                this.syncStatus = {
                    connected: 0,
                    synced: 0,
                    pending: 0,
                    error: 0
                };

                // Realistic base prices for different commodities in different regions (in IDR)
                this.basePrices = {
                    'Beras': {
                        'bpn_new': 13200,  // BPN (Badan Pangan Nasional): Beras Medium
                        'bpn': 13500,  // PIHPS (Bank Indonesia): Beras Kualitas Super I
                        'siskaperbapo': 12884,  // Updated from Siskaperbapo Jatim: Beras Medium
                        'sp2kp': 13400,  // SP2KP (Ministry of Trade): Beras
                        'local': 13700,
                        'jateng': 13200,
                        'produsen': 12500  // Updated to current market prices (around 13500)
                    },
                    'Beras Premium': {
                        'bpn_new': 14500,  // BPN (Badan Pangan Nasional): Beras Premium
                        'bpn': 14800,  // PIHPS (Bank Indonesia): Beras Kualitas Super I
                        'siskaperbapo': 14838,  // Updated from Siskaperbapo Jatim: Beras Premium
                        'sp2kp': 14700,  // SP2KP (Ministry of Trade): Beras Premium
                        'local': 15000,
                        'jateng': 14500,
                        'produsen': 13800  // Updated to current market prices (around 14800)
                    },
                    'Minyak': {
                        'bpn_new': 15200,  // BPN (Badan Pangan Nasional): Minyak Goreng Curah
                        'bpn': 15500,  // PIHPS (Bank Indonesia): Minyak Goreng Curah
                        'siskaperbapo': 18814,  // Updated from Siskaperbapo Jatim: Minyak Goreng Curah
                        'sp2kp': 15900,  // SP2KP (Ministry of Trade): Minyak Goreng
                        'local': 16200,
                        'jateng': 15700,
                        'produsen': 15000  // Updated to current market prices
                    },
                    'Minyak Premium': {
                        'bpn_new': 17200,  // BPN (Badan Pangan Nasional): Minyak Goreng Kemasan Bermerk 1
                        'bpn': 17500,  // PIHPS (Bank Indonesia): Minyak Goreng Kemasan Bermerk 1
                        'siskaperbapo': 20302,  // Updated from Siskaperbapo Jatim: Minyak Goreng Kemasan Premium
                        'sp2kp': 17900,  // SP2KP (Ministry of Trade): Minyak Goreng Premium
                        'local': 18200,
                        'jateng': 17700,
                        'produsen': 17000  // Updated to current market prices
                    },
                    'Gula': {
                        'bpn_new': 13800,  // BPN (Badan Pangan Nasional): Gula Pasir Lokal
                        'bpn': 14000,  // PIHPS (Bank Indonesia): Gula Pasir Lokal
                        'siskaperbapo': 16554,  // Updated from Siskaperbapo Jatim: Gula Kristal Putih
                        'sp2kp': 13900,  // SP2KP (Ministry of Trade): Gula Pasir
                        'local': 14200,
                        'jateng': 13700,
                        'produsen': 13000  // Updated to current market prices
                    },
                    'Gula Premium': {
                        'bpn_new': 15800,  // BPN (Badan Pangan Nasional): Gula Premium
                        'bpn': 14000,  // PIHPS (Bank Indonesia): Gula Pasir Lokal (same as regular sugar for PIHPS)
                        'siskaperbapo': 15800,
                        'sp2kp': 15900,  // SP2KP (Ministry of Trade): Gula Premium
                        'local': 16200,
                        'jateng': 15700,
                        'produsen': 15000  // Updated to current market prices
                    },
                    'Daging': {
                        'bpn_new': 118000,  // BPN (Badan Pangan Nasional): Daging Sapi
                        'bpn': 120000,  // PIHPS (Bank Indonesia): Daging Sapi Kualitas 1
                        'siskaperbapo': 119800,  // Updated from Siskaperbapo Jatim: Daging Sapi Paha Belakang
                        'sp2kp': 129000,  // SP2KP (Ministry of Trade): Daging Sapi
                        'local': 132000,
                        'jateng': 127000,
                        'produsen': 120000  // Updated to current market prices
                    },
                    'Daging Ayam Kampung': {
                        'bpn_new': 68000,  // BPN (Badan Pangan Nasional): Daging Ayam Kampung
                        'bpn': 69346,  // PIHPS (Bank Indonesia): Not available, keeping original
                        'siskaperbapo': 69346,  // Updated from Siskaperbapo Jatim: Daging Ayam Kampung (per ekor)
                        'sp2kp': 49000,  // SP2KP (Ministry of Trade): Daging Ayam Kampung
                        'local': 52000,
                        'jateng': 47000,
                        'produsen': 45000  // Updated to current market prices
                    },
                    'Ayam': {
                        'bpn_new': 37500,  // BPN (Badan Pangan Nasional): Daging Ayam Ras Segar
                        'bpn': 38000,  // PIHPS (Bank Indonesia): Daging Ayam Ras Segar
                        'siskaperbapo': 38848,  // Updated from Siskaperbapo Jatim: Daging Ayam Ras
                        'sp2kp': 37000,  // SP2KP (Ministry of Trade): Daging Ayam
                        'local': 39000,
                        'jateng': 35000,
                        'produsen': 34000  // Updated to current market prices
                    },
                    'Telur': {
                        'bpn_new': 29500,  // BPN (Badan Pangan Nasional): Telur Ayam Ras Segar
                        'bpn': 30000,  // PIHPS (Bank Indonesia): Telur Ayam Ras Segar
                        'siskaperbapo': 30203,  // Updated from Siskaperbapo Jatim: Telur Ayam Ras
                        'sp2kp': 29500,  // SP2KP (Ministry of Trade): Telur Ayam
                        'local': 31000,
                        'jateng': 28500,
                        'produsen': 27000  // Updated to current market prices
                    },
                    'Cabai': {
                        'bpn': 80000,  // PIHPS (Bank Indonesia): Cabai Rawit Merah
                        'siskaperbapo': 83098,  // Updated from Siskaperbapo Jatim: Cabai Rawit Merah
                        'sp2kp': 49000,  // SP2KP (Ministry of Trade): Cabai Rawit
                        'local': 52000,
                        'jateng': 47000,
                        'produsen': 44000  // Updated to current market prices
                    },
                    'Bawang': {
                        'bpn': 32000,  // PIHPS (Bank Indonesia): Bawang Putih Ukuran Sedang
                        'siskaperbapo': 32323,  // Updated from Siskaperbapo Jatim: Bawang Putih Sinco/Honan
                        'sp2kp': 34000,  // SP2KP (Ministry of Trade): Bawang Putih
                        'local': 36000,
                        'jateng': 32000,
                        'produsen': 30000  // Updated to current market prices
                    },
                    'Bawang Merah': {
                        'bpn': 35000,  // PIHPS (Bank Indonesia): Bawang Merah Ukuran Sedang
                        'siskaperbapo': 35534,  // Updated from Siskaperbapo Jatim: Bawang Merah
                        'sp2kp': 37000,  // SP2KP (Ministry of Trade): Bawang Merah
                        'local': 39000,
                        'jateng': 35000,
                        'produsen': 33000  // Updated to current market prices
                    },
                    'Telur Ayam Kampung': {
                        'bpn_new': 29500,  // BPN (Badan Pangan Nasional): Telur Ayam Kampung
                        'bpn': 30000,  // PIHPS (Bank Indonesia): Telur Ayam Ras Segar (using same as regular eggs)
                        'siskaperbapo': 30203,  // Updated from Siskaperbapo Jatim: Same as regular eggs
                        'sp2kp': 39000,  // SP2KP (Ministry of Trade): Telur Ayam Kampung
                        'local': 41000,
                        'jateng': 37000,
                        'produsen': 36000  // Updated to current market prices
                    },
                    'Cabai Merah Besar': {
                        'bpn_new': 29500,  // BPN (Badan Pangan Nasional): Cabai Merah Besar
                        'bpn': 30000,  // PIHPS (Bank Indonesia): Cabai Merah Besar
                        'siskaperbapo': 29680,  // Updated from Siskaperbapo Jatim: Cabai Merah Besar
                        'sp2kp': 54000,  // SP2KP (Ministry of Trade): Cabai Merah
                        'local': 57000,
                        'jateng': 52000,
                        'produsen': 48000  // Updated to current market prices
                    },
                    'Cabai Keriting': {
                        'bpn_new': 30500,  // BPN (Badan Pangan Nasional): Cabai Keriting
                        'bpn': 31000,  // PIHPS (Bank Indonesia): Cabai Merah Keriting
                        'siskaperbapo': 31763,  // Updated from Siskaperbapo Jatim: Cabai Merah Keriting
                        'sp2kp': 51000,  // SP2KP (Ministry of Trade): Cabai Keriting
                        'local': 54000,
                        'jateng': 49000,
                        'produsen': 46000  // Updated to current market prices
                    },
                    'Garam': {
                        'bpn_new': 8200,  // BPN (Badan Pangan Nasional): Garam Dapur
                        'bpn': 9254,  // PIHPS (Bank Indonesia): Not available, keeping original
                        'siskaperbapo': 9254,  // Updated from Siskaperbapo Jatim: Garam Halus
                        'sp2kp': 8400,  // SP2KP (Ministry of Trade): Garam Dapur
                        'local': 8700,
                        'jateng': 8100,
                        'produsen': 7500  // Updated to current market prices
                    },
                    'Tepung': {
                        'bpn_new': 11200,  // BPN (Badan Pangan Nasional): Tepung Terigu
                        'bpn': 11421,  // PIHPS (Bank Indonesia): Not available, keeping original
                        'siskaperbapo': 11421,  // Updated from Siskaperbapo Jatim: Terigu Protein Sedang (Kemasan)
                        'sp2kp': 12400,  // SP2KP (Ministry of Trade): Tepung Terigu
                        'local': 12700,
                        'jateng': 12100,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Wortel': {
                        'bpn_new': 12200,  // BPN (Badan Pangan Nasional): Wortel
                        'bpn': 12445,  // PIHPS (Bank Indonesia): Not available, keeping original
                        'siskaperbapo': 12445,  // Updated from Siskaperbapo Jatim: Wortel
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Wortel
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Sawi': {
                        'bpn_new': 8800,  // BPN (Badan Pangan Nasional): Sawi
                        'bpn': 9000,  // PIHPS (Bank Indonesia): Not available, keeping original
                        'siskaperbapo': 9000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 8800,  // SP2KP (Ministry of Trade): Sawi
                        'local': 9200,
                        'jateng': 8300,
                        'produsen': 7500  // Updated to current market prices
                    },
                    'Jagung': {
                        'bpn_new': 7600,  // BPN (Badan Pangan Nasional): Jagung Kuning
                        'bpn': 7747,
                        'siskaperbapo': 7747,  // Updated from Siskaperbapo Jatim: Jagung Pipilan Kering
                        'sp2kp': 10800,
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    },
                    'Buncis': {
                        'bpn_new': 10600,  // BPN (Badan Pangan Nasional): Buncis
                        'bpn': 10823,
                        'siskaperbapo': 10823,  // Updated from Siskaperbapo Jatim: Buncis
                        'sp2kp': 15800,
                        'local': 16200,
                        'jateng': 15300,
                        'produsen': 14000  // Updated to current market prices
                    },
                    'Brokoli': {
                        'bpn_new': 18500,  // BPN (Badan Pangan Nasional): Brokoli
                        'bpn': 19000,
                        'siskaperbapo': 19000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 18800,
                        'local': 19200,
                        'jateng': 18300,
                        'produsen': 17000  // Updated to current market prices
                    },
                    'Selada': {
                        'bpn_new': 9800,  // BPN (Badan Pangan Nasional): Selada
                        'bpn': 10000,
                        'siskaperbapo': 10000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 9800,
                        'local': 10200,
                        'jateng': 9300,
                        'produsen': 8500  // Updated to current market prices
                    },
                    'Sayur Putih': {
                        'bpn_new': 7800,  // BPN (Badan Pangan Nasional): Sayur Putih
                        'bpn': 8000,
                        'siskaperbapo': 8000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 7800,
                        'local': 8200,
                        'jateng': 7300,
                        'produsen': 6500  // Updated to current market prices
                    },
                    'Pakcoy': {
                        'bpn_new': 9300,  // BPN (Badan Pangan Nasional): Pakcoy
                        'bpn': 9500,
                        'siskaperbapo': 9500,  // Using default value since not in Siskaperbapo
                        'sp2kp': 9300,
                        'local': 9700,
                        'jateng': 8800,
                        'produsen': 8000  // Updated to current market prices
                    },
                    'Jamur Tiram': {
                        'bpn_new': 16800,  // BPN (Badan Pangan Nasional): Jamur Tiram
                        'bpn': 17000,
                        'siskaperbapo': 17000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 16800,
                        'local': 17200,
                        'jateng': 16300,
                        'produsen': 15000  // Updated to current market prices
                    },
                    'Bunga Kol': {
                        'bpn_new': 7700,  // BPN (Badan Pangan Nasional): Bunga Kol
                        'bpn': 7818,
                        'siskaperbapo': 7818,  // Updated from Siskaperbapo Jatim: Kol/Kubis
                        'sp2kp': 10800,
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    },
                    'Kecambah': {
                        'bpn_new': 6800,  // BPN (Badan Pangan Nasional): Kecambah
                        'bpn': 7000,
                        'siskaperbapo': 7000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 6800,
                        'local': 7200,
                        'jateng': 6300,
                        'produsen': 5500  // Updated to current market prices
                    },
                    'Kacang Tanah': {
                        'bpn_new': 34000,  // BPN (Badan Pangan Nasional): Kacang Tanah
                        'bpn': 34630,
                        'siskaperbapo': 34630,  // Updated from Siskaperbapo Jatim: Kacang Tanah
                        'sp2kp': 25800,
                        'local': 26200,
                        'jateng': 25300,
                        'produsen': 24000  // Updated to current market prices
                    },
                    'Seledri': {
                        'bpn_new': 12800,  // BPN (Badan Pangan Nasional): Seledri
                        'bpn': 13000,
                        'siskaperbapo': 12500,
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Seledri
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Asem': {
                        'bpn': 16000,
                        'siskaperbapo': 15500,
                        'sp2kp': 15800,  // SP2KP (Ministry of Trade): Asem
                        'local': 16200,
                        'jateng': 15300,
                        'produsen': 14000  // Updated to current market prices
                    },
                    'Kunyit': {
                        'bpn': 19000,
                        'siskaperbapo': 18500,
                        'sp2kp': 18800,  // SP2KP (Ministry of Trade): Kunyit
                        'local': 19200,
                        'jateng': 18300,
                        'produsen': 17000  // Updated to current market prices
                    },
                    'Kemiri': {
                        'bpn': 23000,
                        'siskaperbapo': 22500,
                        'sp2kp': 22800,  // SP2KP (Ministry of Trade): Kemiri
                        'local': 23200,
                        'jateng': 22300,
                        'produsen': 21000  // Updated to current market prices
                    },
                    'Daun Bawang': {
                        'bpn': 11000,
                        'siskaperbapo': 10500,
                        'sp2kp': 10800,  // SP2KP (Ministry of Trade): Daun Bawang
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    },
                    'Kubis': {
                        'bpn': 9000,
                        'siskaperbapo': 8500,
                        'sp2kp': 8800,  // SP2KP (Ministry of Trade): Kubis
                        'local': 9200,
                        'jateng': 8300,
                        'produsen': 7500  // Updated to current market prices
                    },
                    'Baby Corn': {
                        'bpn': 16000,
                        'siskaperbapo': 15500,
                        'sp2kp': 15800,  // SP2KP (Ministry of Trade): Baby Corn
                        'local': 16200,
                        'jateng': 15300,
                        'produsen': 14000  // Updated to current market prices
                    },
                    'Timun': {
                        'bpn': 10000,
                        'siskaperbapo': 9500,
                        'sp2kp': 9800,  // SP2KP (Ministry of Trade): Timun
                        'local': 10200,
                        'jateng': 9300,
                        'produsen': 8500  // Updated to current market prices
                    },
                    'Kacang Panjang': {
                        'bpn': 13000,
                        'siskaperbapo': 12500,
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Kacang Panjang
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Edaname': {
                        'bpn': 21000,
                        'siskaperbapo': 20500,
                        'sp2kp': 20800,  // SP2KP (Ministry of Trade): Edaname
                        'local': 21200,
                        'jateng': 20300,
                        'produsen': 19000  // Updated to current market prices
                    },
                    'Terong Hijau': {
                        'bpn': 11000,
                        'siskaperbapo': 10500,
                        'sp2kp': 10800,  // SP2KP (Ministry of Trade): Terong Hijau
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    },
                    'Terong Ungu': {
                        'bpn': 11000,
                        'siskaperbapo': 10500,
                        'sp2kp': 10800,  // SP2KP (Ministry of Trade): Terong Ungu
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    },
                    'Tahu': {
                        'bpn': 13000,
                        'siskaperbapo': 12500,
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Tahu
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Tempe': {
                        'bpn': 14000,
                        'siskaperbapo': 13500,
                        'sp2kp': 13800,  // SP2KP (Ministry of Trade): Tempe
                        'local': 14200,
                        'jateng': 13300,
                        'produsen': 12000  // Updated to current market prices
                    },
                    'Susu UHT': {
                        'bpn': 19000,
                        'siskaperbapo': 18500,
                        'sp2kp': 18800,  // SP2KP (Ministry of Trade): Susu UHT
                        'local': 19200,
                        'jateng': 18300,
                        'produsen': 17000  // Updated to current market prices
                    },
                    'Tomat': {
                        'bpn': 8339,  // PIHPS (Bank Indonesia): Not available, keeping original
                        'siskaperbapo': 8339,  // Updated from Siskaperbapo Jatim: Tomat Merah
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Tomat
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Apel Fuji': {
                        'bpn': 26000,
                        'siskaperbapo': 26000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 25800,  // SP2KP (Ministry of Trade): Apel Fuji
                        'local': 26200,
                        'jateng': 25300,
                        'produsen': 24000  // Updated to current market prices
                    },
                    'Apel Hijau Malang': {
                        'bpn': 19000,
                        'siskaperbapo': 19000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 18800,  // SP2KP (Ministry of Trade): Apel Hijau Malang
                        'local': 19200,
                        'jateng': 18300,
                        'produsen': 17000  // Updated to current market prices
                    },
                    'Anggur Merah': {
                        'bpn': 36000,
                        'siskaperbapo': 36000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 35800,  // SP2KP (Ministry of Trade): Anggur Merah
                        'local': 36200,
                        'jateng': 35300,
                        'produsen': 33000  // Updated to current market prices
                    },
                    'Anggur Muscat': {
                        'bpn': 33000,
                        'siskaperbapo': 33000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 32800,  // SP2KP (Ministry of Trade): Anggur Muscat
                        'local': 33200,
                        'jateng': 32300,
                        'produsen': 30000  // Updated to current market prices
                    },
                    'Kelengkeng Emas': {
                        'bpn': 46000,
                        'siskaperbapo': 46000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 45800,  // SP2KP (Ministry of Trade): Kelengkeng Emas
                        'local': 46200,
                        'jateng': 45300,
                        'produsen': 43000  // Updated to current market prices
                    },
                    'Kelengkeng Merah': {
                        'bpn': 43000,
                        'siskaperbapo': 43000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 42800,  // SP2KP (Ministry of Trade): Kelengkeng Merah
                        'local': 43200,
                        'jateng': 42300,
                        'produsen': 40000  // Updated to current market prices
                    },
                    'Minyak Kita': {
                        'bpn': 16196,
                        'siskaperbapo': 16196,  // Updated from Siskaperbapo Jatim: Minyak Goreng MINYAKITA
                        'sp2kp': 16900,  // SP2KP (Ministry of Trade): Minyak Kita
                        'local': 17100,
                        'jateng': 16700,
                        'produsen': 16000  // Updated to current market prices
                    },
                    'Jeruk Santang': {
                        'bpn': 16000,
                        'siskaperbapo': 16000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 15800,  // SP2KP (Ministry of Trade): Jeruk Santang
                        'local': 16200,
                        'jateng': 15300,
                        'produsen': 14000  // Updated to current market prices
                    },
                    'Jeruk Manis': {
                        'bpn': 15000,
                        'siskaperbapo': 15000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 14800,  // SP2KP (Ministry of Trade): Jeruk Manis
                        'local': 15200,
                        'jateng': 14300,
                        'produsen': 13000  // Updated to current market prices
                    },
                    'Jeruk Baby': {
                        'bpn': 21000,
                        'siskaperbapo': 21000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 20800,  // SP2KP (Ministry of Trade): Jeruk Baby
                        'local': 21200,
                        'jateng': 20300,
                        'produsen': 18500  // Updated to current market prices
                    },
                    'Pir Yali': {
                        'bpn': 23000,
                        'siskaperbapo': 23000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 22800,  // SP2KP (Ministry of Trade): Pir Yali
                        'local': 23200,
                        'jateng': 22300,
                        'produsen': 20500  // Updated to current market prices
                    },
                    'Buah Naga': {
                        'bpn': 19000,
                        'siskaperbapo': 19000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 18800,  // SP2KP (Ministry of Trade): Buah Naga
                        'local': 19200,
                        'jateng': 18300,
                        'produsen': 17000  // Updated to current market prices
                    },
                    'Pisang Ambon': {
                        'bpn': 13000,
                        'siskaperbapo': 13000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Pisang Ambon
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Pisang Cavendish': {
                        'bpn': 16000,
                        'siskaperbapo': 16000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 15800,  // SP2KP (Ministry of Trade): Pisang Cavendish
                        'local': 16200,
                        'jateng': 15300,
                        'produsen': 14000  // Updated to current market prices
                    },
                    'Salak Pondoh': {
                        'bpn': 11000,
                        'siskaperbapo': 11000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 10800,  // SP2KP (Ministry of Trade): Salak Pondoh
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    },
                    'Jeruk Lokal': {
                        'bpn': 13000,
                        'siskaperbapo': 13000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 12800,  // SP2KP (Ministry of Trade): Jeruk Lokal
                        'local': 13200,
                        'jateng': 12300,
                        'produsen': 11000  // Updated to current market prices
                    },
                    'Melon': {
                        'bpn_new': 18500,  // BPN (Badan Pangan Nasional): Melon
                        'bpn': 18200,  // PIHPS (Bank Indonesia): Melon
                        'siskaperbapo': 18000,  // Siskaperbapo Jatim: Melon
                        'sp2kp': 17800,  // SP2KP (Ministry of Trade): Melon
                        'local': 18700,
                        'jateng': 17500,
                        'produsen': 16500  // Updated to current market prices
                    },
                    'Semangka': {
                        'bpn': 11000,
                        'siskaperbapo': 11000,  // Using default value since not in Siskaperbapo
                        'sp2kp': 10800,  // SP2KP (Ministry of Trade): Semangka
                        'local': 11200,
                        'jateng': 10300,
                        'produsen': 9000  // Updated to current market prices
                    }
                };
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('id-ID');
                const logEntry = { time: timestamp, message, type };
                this.logs.push(logEntry);
                this.updateLogDisplay();
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            updateLogDisplay() {
                const logContent = document.getElementById('log-content');
                if (logContent) {
                    logContent.innerHTML = this.logs.slice(-20).map(log => 
                        `<div class="${log.type}">[${log.time}] ${log.message}</div>`
                    ).join('');
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }

            async testConnection(endpoint) {
                try {
                    this.log(`Testing connection to ${endpoint.name}...`, 'info');
                    
                    // Simulasi testing koneksi (dalam produksi, gunakan fetch dengan CORS proxy)
                    await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
                    
                    // Simulasi hasil (90% success rate)
                    const isSuccess = Math.random() > 0.1;
                    
                    if (isSuccess) {
                        endpoint.status = 'connected';
                        endpoint.lastSync = new Date().toISOString();
                        this.log(`âœ“ ${endpoint.name} connected successfully`, 'success');
                        return true;
                    } else {
                        throw new Error('Connection timeout');
                    }
                } catch (error) {
                    endpoint.status = 'error';
                    this.log(`âœ— ${endpoint.name} failed: ${error.message}`, 'error');
                    return false;
                }
            }

            async syncAll() {
                this.log('Starting full synchronization...', 'info');
                document.getElementById('sync-status').classList.remove('hidden');
                
                let connected = 0;
                let errors = 0;

                for (const region of DATA_SOURCES) {
                    for (const endpoint of region.endpoints) {
                        endpoint.status = 'syncing';
                        this.updateUI();
                        
                        const success = await this.testConnection(endpoint);
                        if (success) connected++;
                        else errors++;
                        
                        this.updateUI();
                    }
                }

                this.syncStatus = {
                    connected: connected,
                    synced: connected,
                    pending: 0,
                    error: errors
                };

                document.getElementById('sync-status').classList.add('hidden');
                this.log(`Synchronization complete. Connected: ${connected}, Errors: ${errors}`, 'success');
                this.updateStats();
                return this.syncStatus;
            }

            updateUI() {
                renderSourcesGrid();
            }

            updateStats() {
                document.getElementById('stat-connected').textContent = this.syncStatus.connected;
                document.getElementById('stat-synced').textContent = this.syncStatus.synced;
                document.getElementById('stat-pending').textContent = this.syncStatus.pending;
                document.getElementById('stat-error').textContent = this.syncStatus.error;
            }

            getPriceData(source, commodity) {
                // Get base price for the commodity and source
                const basePrice = this.basePrices[commodity] && this.basePrices[commodity][source]
                    ? this.basePrices[commodity][source]
                    : 12400; // fallback price

                // Add small variation to simulate real market fluctuations (Â±3%)
                const variationPercentage = (Math.random() - 0.5) * 0.06; // -3% to +3%
                const variation = basePrice * variationPercentage;

                return Math.round(basePrice + variation);
            }
        }

        const synchronizer = new DataSynchronizer();
        let mapInstance = null;

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        async function initializeApp() {
            initMap();
            renderSourcesGrid();
            renderComparisonTable();
            renderTicker();

            // Auto-sync on load
            setTimeout(async () => {
                await synchronizer.syncAll();
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }, 500);
                document.getElementById('last-sync-time').textContent =
                    'Last sync: ' + new Date().toLocaleString('id-ID');
            }, 1000);
        }

        // ==========================================
        // UI RENDERING
        // ==========================================
        
        function renderSourcesGrid() {
            const grid = document.getElementById('sources-grid');
            
            grid.innerHTML = DATA_SOURCES.map(region => {
                const statusCounts = {
                    connected: region.endpoints.filter(e => e.status === 'connected').length,
                    syncing: region.endpoints.filter(e => e.status === 'syncing').length,
                    error: region.endpoints.filter(e => e.status === 'error').length,
                    unknown: region.endpoints.filter(e => e.status === 'unknown').length
                };
                
                let cardClass = 'data-source-card bg-white p-4 rounded-xl';
                if (statusCounts.syncing > 0) cardClass += ' syncing';
                else if (statusCounts.error === region.endpoints.length) cardClass += ' error';
                else if (statusCounts.connected === region.endpoints.length) cardClass += ' synced';
                
                return `
                    <div class="${cardClass}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-bold">Zona ${region.zone}</span>
                                    <h3 class="font-bold text-slate-800">${region.kabupaten}</h3>
                                </div>
                                <div class="text-xs text-slate-500">${region.endpoints.length} data sources</div>
                            </div>
                            <div class="flex gap-1">
                                ${statusCounts.connected > 0 ? `<span class="w-3 h-3 bg-green-500 rounded-full" title="${statusCounts.connected} connected"></span>` : ''}
                                ${statusCounts.syncing > 0 ? `<span class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse" title="${statusCounts.syncing} syncing"></span>` : ''}
                                ${statusCounts.error > 0 ? `<span class="w-3 h-3 bg-red-500 rounded-full" title="${statusCounts.error} error"></span>` : ''}
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${region.endpoints.map(endpoint => {
                                let statusColor = 'bg-slate-200';
                                let statusIcon = 'fa-circle';
                                if (endpoint.status === 'connected') {
                                    statusColor = 'bg-green-100 text-green-700';
                                    statusIcon = 'fa-check-circle';
                                } else if (endpoint.status === 'syncing') {
                                    statusColor = 'bg-yellow-100 text-yellow-700';
                                    statusIcon = 'fa-sync fa-spin';
                                } else if (endpoint.status === 'error') {
                                    statusColor = 'bg-red-100 text-red-700';
                                    statusIcon = 'fa-exclamation-circle';
                                }
                                
                                return `
                                    <div class="flex items-center justify-between p-2 ${statusColor} rounded-lg text-xs">
                                        <div class="flex items-center gap-2">
                                            <i class="fas ${statusIcon}"></i>
                                            <span class="font-medium">${endpoint.name}</span>
                                        </div>
                                        <a href="${endpoint.url}" target="_blank" class="hover:underline">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <button onclick="showEndpointDetails('${region.kabupaten}')" class="w-full mt-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-bold text-slate-700 transition-colors">
                            <i class="fas fa-info-circle"></i> Detail Koneksi
                        </button>
                    </div>
                `;
            }).join('');
        }

        // SISKAPERBAPO Jatim commodities based on https://siskaperbapo.jatimprov.go.id/
        const SISKAPERBAPO_COMMODITIES = [
            'Beras', // Beras Medium / kg
            'Beras Premium', // Beras Premium / kg
            'Gula', // Gula Kristal Putih / kg
            'Minyak', // Minyak Goreng Curah / kg
            'Minyak Premium', // Minyak Goreng Kemasan Premium / liter
            'Daging', // Daging Sapi Paha Belakang / kg
            'Ayam', // Daging Ayam Ras / kg
            'Daging Ayam Kampung', // Daging Ayam Kampung / ekor
            'Telur', // Telur Ayam Ras / kg
            'Telur Ayam Kampung', // Telur Ayam Kampung / kg
            'Susu UHT', // Susu Kental Manis / Susu Bubuk
            'Jagung', // Jagung Pipilan Kering / kg
            'Garam', // Garam Beryodium / kg
            'Tepung', // Tepung Terigu / kg
            'Kacang Kedelai', // Kacang Kedelai Impor/Lokal / kg
            'Cabai Keriting', // Cabe Merah Keriting / kg
            'Cabai Merah Besar', // Cabe Merah Besar / kg
            'Cabai', // Cabe Rawit Merah / kg
            'Bawang Merah', // Bawang Merah / kg
            'Bawang', // Bawang Putih / kg
            'Ikan Asin', // Ikan Asin Teri / kg
            'Kacang Hijau', // Kacang Hijau / kg
            'Kacang Tanah', // Kacang Tanah / kg
            'Singkong', // Ketela Pohon / kg
            'Kubis', // Kol/kubis / kg
            'Kentang', // Kentang / kg
            'Tomat', // Tomat / kg
            'Wortel', // Wortel / kg
            'Buncis', // Buncis / kg
            'Ikan Bandeng', // Ikan Bandeng / kg
            'Ikan Kembung', // Ikan Kembung / kg
            'Ikan Tuna', // Ikan Tuna / kg
            'Ikan Tongkol', // Ikan Tongkol / kg
        ];

        // PIHPS (Bank Indonesia) tracks 9 main strategic food commodities
        // Source: https://www.bi.go.id/hargapangan
        const PIHPS_COMMODITIES = [
            'Beras', // Beras Medium - tracked by BI PIHPS
            'Gula', // Gula Pasir - tracked by BI PIHPS
            'Minyak', // Minyak Goreng Curah - tracked by BI PIHPS
            'Daging', // Daging Sapi - tracked by BI PIHPS
            'Ayam', // Daging Ayam Ras - tracked by BI PIHPS
            'Telur', // Telur Ayam Ras - tracked by BI PIHPS
            'Cabai', // Cabai Rawit Merah - tracked by BI PIHPS
            'Cabai Merah Besar', // Cabai Merah Besar - tracked by BI PIHPS
            'Bawang Merah', // Bawang Merah - tracked by BI PIHPS
            'Jagung', // Jagung - tracked by BI PIHPS
        ];

        // SP2KP (Kemendag) tracks 16 main strategic food commodities
        // Source: https://sp2kp.kemendag.go.id/
        const SP2KP_COMMODITIES = [
            'Beras', // Beras Medium - tracked by SP2KP
            'Beras Premium', // Beras Premium - tracked by SP2KP
            'Gula', // Gula Pasir Curah - tracked by SP2KP
            'Minyak', // Minyak Goreng Sawit Curah - tracked by SP2KP
            'Minyak Premium', // Minyak Goreng Sawit Kemasan Premium - tracked by SP2KP
            'Daging', // Daging Sapi Paha Belakang - tracked by SP2KP
            'Ayam', // Daging Ayam Ras - tracked by SP2KP
            'Telur', // Telur Ayam Ras - tracked by SP2KP
            'Cabai', // Cabai Rawit Merah - tracked by SP2KP
            'Cabai Merah Besar', // Cabai Merah Besar - tracked by SP2KP
            'Cabai Keriting', // Cabai Merah Keriting - tracked by SP2KP
            'Bawang', // Bawang Putih - tracked by SP2KP
            'Bawang Merah', // Bawang Merah - tracked by SP2KP
            'Tepung', // Tepung Terigu - tracked by SP2KP
            'Kacang Kedelai', // Kedelai Impor - tracked by SP2KP
            'Minyak Kita', // Minyakita - tracked by SP2KP
        ];

        // BPN (Badan Pangan Nasional) only tracks 9 main strategic commodities
        // Source: https://panelharga.badanpangan.go.id/beranda
        const BPN_COMMODITIES = [
            'Beras', // Beras medium - tracked by BPN
            'Gula', // Gula Pasir - tracked by BPN
            'Minyak', // Minyak Goreng Curah - tracked by BPN
            'Daging', // Daging Sapi - tracked by BPN
            'Ayam', // Daging Ayam - tracked by BPN
            'Telur', // Telur Ayam Ras - tracked by BPN
            'Cabai', // Cabai Rawit Merah - tracked by BPN
            'Bawang Merah', // Bawang Merah - tracked by BPN
            'Bawang' // Bawang Putih - tracked by BPN
        ];

        function renderComparisonTable(commodity = 'all', zoneFilter = 'all') {
            const tbody = document.getElementById('comparison-table-body');

            // Filter regions based on selected zone
            let filteredDataSources = DATA_SOURCES;
            if (zoneFilter !== 'all') {
                filteredDataSources = DATA_SOURCES.filter(region => region.zone == zoneFilter);
            }

            // Define all commodities
            const allCommodities = ['Beras', 'Beras Premium', 'Minyak', 'Minyak Premium', 'Gula', 'Gula Premium', 'Daging', 'Daging Ayam Kampung', 'Ayam', 'Telur', 'Telur Ayam Kampung', 'Cabai', 'Cabai Merah Besar', 'Cabai Keriting', 'Bawang', 'Bawang Merah', 'Garam', 'Tepung', 'Wortel', 'Sawi', 'Jagung', 'Buncis', 'Brokoli', 'Selada', 'Sayur Putih', 'Pakcoy', 'Jamur Tiram', 'Bunga Kol', 'Kecambah', 'Kacang Tanah', 'Seledri', 'Asem', 'Kunyit', 'Kemiri', 'Daun Bawang', 'Kubis', 'Baby Corn', 'Timun', 'Kacang Panjang', 'Edaname', 'Terong Hijau', 'Terong Ungu', 'Tahu', 'Tempe', 'Susu UHT', 'Tomat', 'Apel Fuji', 'Apel Hijau Malang', 'Anggur Merah', 'Anggur Muscat', 'Kelengkeng Emas', 'Kelengkeng Merah', 'Minyak Kita', 'Jeruk Santang', 'Jeruk Manis', 'Jeruk Baby', 'Pir Yali', 'Buah Naga', 'Pisang Ambon', 'Pisang Cavendish', 'Salak Pondoh', 'Jeruk Lokal', 'Melon', 'Semangka'];

            // Determine which commodities to display
            const commoditiesToDisplay = commodity === 'all' ? allCommodities : [commodity];

            // Generate rows for each region and each commodity
            let tableRows = '';
            filteredDataSources.forEach(region => {
                commoditiesToDisplay.forEach(currentCommodity => {
                    const prices = {
                        bpn_new: BPN_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('bpn_new', currentCommodity) : null, // BPN from Badan Pangan
                        bpn: PIHPS_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('bpn', currentCommodity) : null, // PIHPS from Bank Indonesia
                        siskaperbapo: SISKAPERBAPO_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('siskaperbapo', currentCommodity) : null,
                        sp2kp: SP2KP_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('sp2kp', currentCommodity) : null,
                        local: region.endpoints.find(e => e.type === 'local') ?
                            synchronizer.getPriceData('local', currentCommodity) : null,
                        produsen: synchronizer.getPriceData('produsen', currentCommodity)
                    };

                    // Calculate average excluding null values (for bpn_new, bpn, siskaperbapo, and sp2kp when not available)
                    const validPrices = [prices.bpn_new, prices.bpn, prices.siskaperbapo, prices.sp2kp, prices.local || prices.sp2kp, prices.produsen].filter(price => price !== null);
                    const avg = Math.round(validPrices.reduce((sum, price) => sum + price, 0) / validPrices.length);

                    tableRows += `
                        <tr class="hover:bg-orange-50 transition-colors border-b border-slate-100">
                            <td class="p-3 font-medium text-slate-800">${region.kabupaten}</td>
                            <td class="p-3 text-center">
                                <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">${region.zone}</span>
                            </td>
                            <td class="p-3 font-medium text-slate-800">${currentCommodity}</td>
                            <td class="p-3 text-right font-mono ${prices.bpn_new !== null ? '' : 'text-slate-400'}">
                                ${prices.bpn_new !== null ? 'Rp' + prices.bpn_new.toLocaleString() : '-'}
                            </td>
                            <td class="p-3 text-right font-mono ${prices.bpn !== null ? '' : 'text-slate-400'}">
                                ${prices.bpn !== null ? 'Rp' + prices.bpn.toLocaleString() : '-'}
                            </td>
                            <td class="p-3 text-right font-mono ${prices.siskaperbapo !== null ? '' : 'text-slate-400'}">
                                ${prices.siskaperbapo !== null ? 'Rp' + prices.siskaperbapo.toLocaleString() : '-'}
                            </td>
                            <td class="p-3 text-right font-mono ${prices.sp2kp !== null ? '' : 'text-slate-400'}">
                                ${prices.sp2kp !== null ? 'Rp' + prices.sp2kp.toLocaleString() : '-'}
                            </td>
                            <td class="p-3 text-right font-mono ${prices.local ? '' : 'text-slate-400'}">
                                ${prices.local ? 'Rp' + prices.local.toLocaleString() : '-'}
                            </td>
                            <td class="p-3 text-right font-mono">Rp${prices.produsen.toLocaleString()}</td>
                            <td class="p-3 text-right font-mono font-bold text-orange-600">Rp${avg.toLocaleString()}</td>
                        </tr>
                    `;
                });
            });

            tbody.innerHTML = tableRows;
            
            // Reapply search filter after table is updated
            setTimeout(searchTable, 100); // Small delay to ensure DOM is updated
        }

        function renderTicker() {
            const ticker = document.getElementById('price-ticker');
            const commodities = ['Beras', 'Beras Premium', 'Minyak', 'Minyak Premium', 'Gula', 'Gula Premium', 'Daging', 'Daging Ayam Kampung', 'Ayam', 'Telur', 'Telur Ayam Kampung', 'Cabai', 'Cabai Merah Besar', 'Cabai Keriting', 'Bawang', 'Bawang Merah', 'Garam', 'Tepung', 'Wortel', 'Sawi', 'Jagung', 'Buncis', 'Brokoli', 'Selada', 'Sayur Putih', 'Pakcoy', 'Jamur Tiram', 'Bunga Kol', 'Kecambah', 'Kacang Tanah', 'Seledri', 'Asem', 'Kunyit', 'Kemiri', 'Daun Bawang', 'Kubis', 'Baby Corn', 'Timun', 'Kacang Panjang', 'Edaname', 'Terong Hijau', 'Terong Ungu', 'Tahu', 'Tempe', 'Susu UHT', 'Tomat', 'Apel Fuji', 'Apel Hijau Malang', 'Anggur Merah', 'Anggur Muscat', 'Kelengkeng Emas', 'Kelengkeng Merah', 'Minyak Kita', 'Jeruk Santang', 'Jeruk Manis', 'Jeruk Baby', 'Pir Yali', 'Buah Naga', 'Pisang Ambon', 'Pisang Cavendish', 'Salak Pondoh', 'Jeruk Lokal', 'Melon', 'Semangka'];
            const emoji = {
                'Beras': 'ğŸŒ¾',
                'Beras Premium': 'ğŸš',
                'Minyak': 'ğŸ›¢ï¸',
                'Minyak Premium': 'â›½',
                'Gula': 'ğŸ¬',
                'Gula Premium': 'ğŸ¯',
                'Daging': 'ğŸ¥©',
                'Daging Ayam Kampung': 'ğŸ—',
                'Ayam': 'ğŸ”',
                'Telur': 'ğŸ¥š',
                'Telur Ayam Kampung': 'ğŸ£',
                'Cabai': 'ğŸŒ¶ï¸',
                'Cabai Merah Besar': 'ğŸ”´',
                'Cabai Keriting': 'â°',
                'Bawang': 'ğŸ§…',
                'Bawang Merah': 'ğŸ§…',
                'Garam': 'ğŸ§‚',
                'Tepung': 'ğŸ',
                'Wortel': 'ğŸ¥•',
                'Sawi': 'ğŸ¥¬',
                'Jagung': 'ğŸŒ½',
                'Buncis': 'ğŸ«˜',
                'Brokoli': 'ğŸ¥¦',
                'Selada': 'ğŸ¥—',
                'Sayur Putih': 'ğŸ¥¬',
                'Pakcoy': 'ğŸ¥¬',
                'Jamur Tiram': 'ğŸ„',
                'Bunga Kol': 'ğŸ¥¬',
                'Kecambah': 'ğŸŒ±',
                'Kacang Tanah': 'ğŸ¥œ',
                'Seledri': 'ğŸŒ¿',
                'Asem': 'ğŸ‹',
                'Kunyit': 'ğŸ’›',
                'Kemiri': 'ğŸŒ°',
                'Daun Bawang': 'ğŸŒ¿',
                'Kubis': 'ğŸ¥¬',
                'Baby Corn': 'ğŸŒ½',
                'Timun': 'ğŸ¥’',
                'Kacang Panjang': 'ğŸ«˜',
                'Edaname': 'ğŸŒ±',
                'Terong Hijau': 'ğŸ†',
                'Terong Ungu': 'ğŸ†',
                'Tahu': 'â¬œ',
                'Tempe': 'ğŸŸ¤',
                'Susu UHT': 'ğŸ¥›',
                'Tomat': 'ğŸ…',
                'Apel Fuji': 'ğŸ',
                'Apel Hijau Malang': 'ğŸ',
                'Anggur Merah': 'ğŸ‡',
                'Anggur Muscat': 'ğŸˆ',
                'Kelengkeng Emas': 'ğŸ’',
                'Kelengkeng Merah': 'ğŸ’',
                'Minyak Kita': 'ğŸ«’',
                'Jeruk Santang': 'ğŸŠ',
                'Jeruk Manis': 'ğŸŠ',
                'Jeruk Baby': 'ğŸŠ',
                'Pir Yali': 'ğŸ',
                'Buah Naga': 'ğŸ‰',
                'Pisang Ambon': 'ğŸŒ',
                'Pisang Cavendish': 'ğŸŒ',
                'Salak Pondoh': 'ğŸ¥­',
                'Jeruk Lokal': 'ğŸŠ',
                'Melon': 'ğŸˆ',
                'Semangka': 'ğŸ‰'
            };

            const items = DATA_SOURCES.slice(0, 8).map((region, idx) => {
                const commodity = commodities[idx % commodities.length];
                const price = synchronizer.getPriceData('bpn', commodity);
                
                // More realistic price changes based on commodity type
                let change;
                // Different commodities have different volatility levels
                if (['Cabai', 'Cabai Merah Besar', 'Cabai Keriting', 'Bawang', 'Bawang Merah'].includes(commodity)) {
                    // Spices and onions tend to have higher price volatility
                    change = (Math.random() * 15 - 7).toFixed(1);
                } else if (['Daging', 'Daging Ayam Kampung', 'Ayam', 'Telur', 'Telur Ayam Kampung'].includes(commodity)) {
                    // Protein items have moderate volatility
                    change = (Math.random() * 8 - 4).toFixed(1);
                } else if (['Beras', 'Gula', 'Garam', 'Tepung'].includes(commodity)) {
                    // Staple items have lower volatility
                    change = (Math.random() * 4 - 2).toFixed(1);
                } else {
                    // Other items have moderate volatility
                    change = (Math.random() * 6 - 3).toFixed(1);
                }
                
                const color = change > 0 ? 'text-red-500' : 'text-green-500';
                const arrow = change > 0 ? 'â†—ï¸' : 'â†˜ï¸';

                return `
                    <div class="flex-shrink-0 neo-card px-4 py-3 flex items-center gap-3 min-w-[240px]">
                        <span class="text-2xl">${emoji[commodity]}</span>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800 text-sm">${commodity}</span>
                                <span class="text-xs text-slate-500">â€¢ ${region.kabupaten}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="font-black text-slate-900">Rp${(price/1000).toFixed(1)}k</span>
                                <span class="${color} text-xs font-bold">${arrow} ${Math.abs(change)}%</span>
                            </div>
                            <div class="flex gap-1 mt-1">
                                <span class="text-[10px] px-2 py-0.5 bg-blue-100 text-blue-700 rounded">BPN</span>
                                <span class="text-[10px] px-2 py-0.5 bg-green-100 text-green-700 rounded">Sync</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            ticker.innerHTML = items.join('') + items.join('');
        }

        // ==========================================
        // MAP INITIALIZATION
        // ==========================================
        
        function initMap() {
            mapInstance = L.map('map').setView([-7.8, 112.5], 8);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(mapInstance);

            DATA_SOURCES.forEach(region => {
                const avgPrice = 12000 + Math.random() * 3000;
                const color = region.zone <= 3 ? '#ef4444' : region.zone <= 6 ? '#f59e0b' : '#10b981';
                
                const marker = L.marker(region.coords, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="w-14 h-14 bg-white border-4 border-[${color}] rounded-full shadow-xl flex flex-col items-center justify-center font-bold text-xs text-slate-800 hover:scale-110 transition-transform">
                                <span class="text-[10px] text-slate-500">Z${region.zone}</span>
                                <span>${(avgPrice/1000).toFixed(0)}k</span>
                               </div>`,
                        iconSize: [56, 56],
                        iconAnchor: [28, 28]
                    })
                }).addTo(mapInstance);

                const popupContent = `
                    <div class="p-4 min-w-[300px]">
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b">
                            <span class="px-2 py-1 bg-orange-500 text-white rounded text-xs font-bold">Zona ${region.zone}</span>
                            <h3 class="font-fredoka text-lg font-bold text-slate-800">${region.kabupaten}</h3>
                        </div>
                        
                        <div class="space-y-2 mb-3">
                            ${region.endpoints.map(endpoint => {
                                const price = synchronizer.getPriceData(endpoint.type, 'Beras');
                                const statusColor = endpoint.status === 'connected' ? 'text-green-600' : 
                                                  endpoint.status === 'error' ? 'text-red-600' : 'text-slate-400';
                                return `
                                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg text-sm">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-circle text-[8px] ${statusColor}"></i>
                                            <span class="font-medium text-slate-700">${endpoint.name}</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-slate-900">Rp${price.toLocaleString()}</div>
                                            <div class="text-[10px] text-slate-500">${endpoint.status}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="pt-2 border-t flex gap-2">
                            <button onclick="syncRegion('${region.kabupaten}')" class="flex-1 py-2 bg-orange-500 text-white rounded-lg text-xs font-bold hover:bg-orange-600 transition-colors">
                                <i class="fas fa-sync"></i> Sync Now
                            </button>
                            <a href="${region.endpoints[0].url}" target="_blank" class="flex-1 py-2 bg-slate-100 text-slate-700 rounded-lg text-xs font-bold text-center hover:bg-slate-200 transition-colors">
                                <i class="fas fa-external-link-alt"></i> Visit
                            </a>
                        </div>
                    </div>
					
                `;

                marker.bindPopup(popupContent);
            });
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        
        async function forceSync() {
            const icon = document.getElementById('sync-icon');
            icon.classList.add('fa-spin');
            
            await synchronizer.syncAll();
            
            icon.classList.remove('fa-spin');
            renderComparisonTable();
            renderTicker();
            
            document.getElementById('last-sync-time').textContent = 
                'Last sync: ' + new Date().toLocaleString('id-ID');
            
            showToast('âœ¨ Sinkronisasi 34 endpoint berhasil!');
        }

        function testAllConnections() {
            synchronizer.syncAll();
            showToast('ğŸ§ª Testing all connections...');
        }

        function viewAPILogs() {
            const console = document.getElementById('api-console');
            console.classList.toggle('hidden');
        }

        function clearLogs() {
            synchronizer.logs = [];
            synchronizer.updateLogDisplay();
        }

        function showEndpointDetails(kabupaten) {
            const region = DATA_SOURCES.find(r => r.kabupaten === kabupaten);
            if (!region) return;
            
            const content = `
                <div class="space-y-4">
                    <div class="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">
                        <h4 class="font-bold text-orange-900 mb-2">${region.kabupaten} (Zona ${region.zone})</h4>
                        <p class="text-sm text-orange-800">Tipe: ${region.type}</p>
                        <p class="text-sm text-orange-800">Koordinat: ${region.coords.join(', ')}</p>
                    </div>
                    
                    <div class="space-y-3">
                        ${region.endpoints.map(endpoint => `
                            <div class="p-4 border-2 ${endpoint.status === 'connected' ? 'border-green-200 bg-green-50' : 'border-slate-200 bg-slate-50'} rounded-xl">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-slate-800">${endpoint.name}</div>
                                        <div class="text-xs text-slate-500 font-mono mt-1">${endpoint.url}</div>
                                    </div>
                                    <span class="px-3 py-1 ${endpoint.status === 'connected' ? 'bg-green-500' : endpoint.status === 'error' ? 'bg-red-500' : 'bg-slate-400'} text-white rounded-full text-xs font-bold">
                                        ${endpoint.status.toUpperCase()}
                                    </span>
                                </div>
                                
                                ${endpoint.lastSync ? `
                                    <div class="text-xs text-slate-600 mt-2">
                                        <i class="fas fa-clock"></i> Last sync: ${new Date(endpoint.lastSync).toLocaleString('id-ID')}
                                    </div>
                                ` : ''}
                                
                                <div class="mt-3 flex gap-2">
                                    <button onclick="testEndpoint('${region.kabupaten}', '${endpoint.name}')" class="flex-1 py-2 bg-white border-2 border-slate-200 rounded-lg text-xs font-bold hover:border-orange-500 transition-colors">
                                        <i class="fas fa-vial"></i> Test
                                    </button>
                                    <a href="${endpoint.url}" target="_blank" class="flex-1 py-2 bg-blue-500 text-white rounded-lg text-xs font-bold text-center hover:bg-blue-600 transition-colors">
                                        <i class="fas fa-external-link-alt"></i> Open
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            showModal(`ğŸ”Œ Detail Koneksi: ${region.kabupaten}`, content);
        }

        async function testEndpoint(kabupaten, endpointName) {
            const region = DATA_SOURCES.find(r => r.kabupaten === kabupaten);
            const endpoint = region.endpoints.find(e => e.name === endpointName);
            
            showToast(`ğŸ§ª Testing ${endpointName}...`);
            await synchronizer.testConnection(endpoint);
            renderSourcesGrid();
        }

        function syncRegion(kabupaten) {
            const region = DATA_SOURCES.find(r => r.kabupaten === kabupaten);
            region.endpoints.forEach(async endpoint => {
                endpoint.status = 'syncing';
                renderSourcesGrid();
                await synchronizer.testConnection(endpoint);
                renderSourcesGrid();
            });
            showToast(`ğŸ”„ Syncing ${kabupaten}...`);
        }

        function changeRegion(value) {
            if (value === 'all') {
                mapInstance.flyTo([-7.8, 112.5], 8, { duration: 1.5 });
            } else {
                const zoneRegions = DATA_SOURCES.filter(r => r.zone == value);
                if (zoneRegions.length > 0) {
                    const coords = zoneRegions[0].coords;
                    mapInstance.flyTo(coords, 10, { duration: 1.5 });
                }
            }
            
            // Clear search when region filter changes
            document.getElementById('search-input').value = '';
            document.getElementById('clear-search-btn').classList.add('hidden');
        }

        function filterMap(type) {
            showToast(`ğŸ—ºï¸ Filter: ${type === 'all' ? 'Semua Komoditas' : type}`);
            // In a real implementation, this would filter the map markers based on the selected commodity
            // For now, just showing the toast notification
        }

        function updateComparison() {
            const selectedCommodity = document.getElementById('compare-commodity').value;
            const selectedZone = document.getElementById('compare-region').value;
            
            // Clear search when commodity filter changes
            document.getElementById('search-input').value = '';
            document.getElementById('clear-search-btn').classList.add('hidden');
            
            renderComparisonTable(selectedCommodity, selectedZone);
            // Also trigger search in case there was text in the search box
            searchTable();
        }
        
        function searchTable() {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('comparison-table-body');
            const tr = table.getElementsByTagName('tr');
            
            // Show/hide clear button based on input
            const clearBtn = document.getElementById('clear-search-btn');
            if (input.value.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            
            // Loop through all table rows, and hide those who don't match the search query
            for (let i = 0; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[2]; // Column index 2 is the commodity name
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }
        
        // Clear search function
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('clear-search-btn').classList.add('hidden');
            searchTable();
        }

        function exportComparison() {
            // Temporarily clear search for export to include all data
            const searchValue = document.getElementById('search-input').value;
            document.getElementById('search-input').value = '';
            document.getElementById('clear-search-btn').classList.add('hidden');
            
            const selectedCommodity = document.getElementById('compare-commodity').value;
            const selectedZone = document.getElementById('compare-region').value;
            const currentDate = new Date().toLocaleDateString('id-ID');
            const currentTime = new Date().toLocaleTimeString('id-ID');

            // Define all commodities
            const allCommodities = ['Beras', 'Beras Premium', 'Minyak', 'Minyak Premium', 'Gula', 'Gula Premium', 'Daging', 'Daging Ayam Kampung', 'Ayam', 'Telur', 'Telur Ayam Kampung', 'Cabai', 'Cabai Merah Besar', 'Cabai Keriting', 'Bawang', 'Bawang Merah', 'Garam', 'Tepung', 'Wortel', 'Sawi', 'Jagung', 'Buncis', 'Brokoli', 'Selada', 'Sayur Putih', 'Pakcoy', 'Jamur Tiram', 'Bunga Kol', 'Kecambah', 'Kacang Tanah', 'Seledri', 'Asem', 'Kunyit', 'Kemiri', 'Daun Bawang', 'Kubis', 'Baby Corn', 'Timun', 'Kacang Panjang', 'Edaname', 'Terong Hijau', 'Terong Ungu', 'Tahu', 'Tempe', 'Susu UHT', 'Tomat', 'Apel Fuji', 'Apel Hijau Malang', 'Anggur Merah', 'Anggur Muscat', 'Kelengkeng Emas', 'Kelengkeng Merah', 'Minyak Kita', 'Jeruk Santang', 'Jeruk Manis', 'Jeruk Baby', 'Pir Yali', 'Buah Naga', 'Pisang Ambon', 'Pisang Cavendish', 'Salak Pondoh', 'Jeruk Lokal', 'Melon', 'Semangka'];

            // Filter data based on selected zone
            let filteredDataSources = DATA_SOURCES;
            if (selectedZone !== 'all') {
                filteredDataSources = DATA_SOURCES.filter(region => region.zone == selectedZone);
            }

            // Determine which commodities to export
            const commoditiesToExport = selectedCommodity === 'all' ? allCommodities : [selectedCommodity];

            // Use appropriate title based on whether all commodities are being exported
            const exportTitle = selectedCommodity === 'all' ? 'Semua Komoditas' : selectedCommodity;

            // Create HTML table for Excel export
            let htmlContent = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="utf-8">
                    <title>Data Harga ${exportTitle}</title>
                    <style>
                        table { border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header { font-weight: bold; font-size: 14px; margin-bottom: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>Data Harga ${exportTitle}</h2>
                        <p>Zona: ${selectedZone === 'all' ? 'Semua Zona' : 'Zona ' + selectedZone}</p>
                        <p>Tanggal Update: ${currentDate} | Jam: ${currentTime}</p>
                        <p>Dibuat oleh: Logistik Jitu Update (LJU)</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Wilayah</th>
                                <th>Zona</th>
                                <th>Nama Barang</th>
                                <th>BPN</th>
                                <th>PIHPS</th>
                                <th>Siskaperbapo</th>
                                <th>SP2KP</th>
                                <th>Local API</th>
                                <th>Harga Produsen</th>
                                <th>Rata-rata</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            filteredDataSources.forEach(r => {
                commoditiesToExport.forEach(currentCommodity => {
                    const prices = {
                        bpn_new: BPN_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('bpn_new', currentCommodity) : null, // BPN from Badan Pangan
                        bpn: PIHPS_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('bpn', currentCommodity) : null, // PIHPS from Bank Indonesia
                        siskaperbapo: SISKAPERBAPO_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('siskaperbapo', currentCommodity) : null,
                        sp2kp: SP2KP_COMMODITIES.includes(currentCommodity) ?
                            synchronizer.getPriceData('sp2kp', currentCommodity) : null,
                        local: r.endpoints.find(e => e.type === 'local') ? synchronizer.getPriceData('local', currentCommodity) : '',
                        produsen: synchronizer.getPriceData('produsen', currentCommodity)
                    };

                    // Calculate average excluding null values (for bpn_new, bpn, siskaperbapo, and sp2kp when not available)
                    const validPrices = [prices.bpn_new, prices.bpn, prices.siskaperbapo, prices.sp2kp, (prices.local || prices.sp2kp), prices.produsen].filter(price => price !== null);
                    const avg = Math.round(validPrices.reduce((sum, price) => sum + price, 0) / validPrices.length);

                    htmlContent += `
                        <tr>
                            <td>${r.kabupaten}</td>
                            <td>${r.zone}</td>
                            <td>${currentCommodity}</td>
                            <td>${prices.bpn_new !== null ? prices.bpn_new.toLocaleString() : '-'}</td>
                            <td>${prices.bpn !== null ? prices.bpn.toLocaleString() : '-'}</td>
                            <td>${prices.siskaperbapo !== null ? prices.siskaperbapo.toLocaleString() : '-'}</td>
                            <td>${prices.sp2kp !== null ? prices.sp2kp.toLocaleString() : '-'}</td>
                            <td>${prices.local || '-'}</td>
                            <td>${prices.produsen.toLocaleString()}</td>
                            <td>${avg.toLocaleString()}</td>
                        </tr>
                    `;
                });
            });

            htmlContent += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', htmlContent], { type: 'application/vnd.ms-excel' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fileNameCommodity = selectedCommodity === 'all' ? 'Semua_Komoditas' : selectedCommodity;
            a.href = url;
            a.download = `LJU_Comparison_${fileNameCommodity}_Zona${selectedZone}_${new Date().toISOString().slice(0, 10)}.xls`;
            a.click();
            window.URL.revokeObjectURL(url);

            // Restore search value after export
            document.getElementById('search-input').value = searchValue;
            if (searchValue) {
                document.getElementById('clear-search-btn').classList.remove('hidden');
            } else {
                document.getElementById('clear-search-btn').classList.add('hidden');
            }
            
            // Reapply search filter
            searchTable();

            showToast('ğŸ“¥ Export Excel berhasil!');
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-overlay').classList.add('flex');
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0');
                document.getElementById('modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            document.getElementById('modal-content').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('modal-overlay').classList.add('hidden');
                document.getElementById('modal-overlay').classList.remove('flex');
            }, 300);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 right-6 bg-slate-800 text-white px-6 py-4 rounded-2xl shadow-2xl z-50 flex items-center gap-3 animate-fade-in font-bold';
            toast.innerHTML = `<span class="text-2xl">âœ¨</span> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Update date and time in the widget
        function updateDateTimeWidget() {
            const now = new Date();
            const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            
            const dateString = now.toLocaleDateString('id-ID', dateOptions);
            const timeString = now.toLocaleTimeString('id-ID', timeOptions);
            
            document.getElementById('current-date').textContent = dateString;
            document.getElementById('current-time').textContent = timeString;
        }
        
        // Initialize and update the date/time widget every second
        setInterval(updateDateTimeWidget, 1000);
        updateDateTimeWidget(); // Initial call
        
        // iOS viewport fix for devices with dynamic island or home indicator
        function iosViewportFix() {
            if (navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i)) {
                // Set the viewport height to account for dynamic island or home indicator
                document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
                
                // Listen for resize events to handle orientation changes
                window.addEventListener('resize', function() {
                    document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
                });
            }
        }
        
        // Call the iOS fix on load
        iosViewportFix();
    </script>
</body>
</html>
